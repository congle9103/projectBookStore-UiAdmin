import {
  Table,
  Image,
  Tag,
  Alert,
  Select,
  Space,
  Button,
  Input,
  Modal,
  Form,
  Row,
  Col,
  Checkbox,
  message,
  Popconfirm,
  Pagination,
} from "antd";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import axios from "axios";
import Search from "antd/es/input/Search";
import { useState } from "react";
import { useSearchParams } from "react-router-dom";
import type { Product } from "../types/product.type";

const API_URL = `https://projectbookstore-backendapi.onrender.com/api/v1/products`;

// ========================================
// üîπ H√†m g·ªçi API backend (chu·∫©n service findAll)
// ========================================
const fetchProducts = async ({
  page = 1,
  limit = 5,
  keyword,
  sort_by,
  sort_type,
  cat_id,
}: {
  page?: number;
  limit?: number;
  keyword?: string;
  sort_by?: string;
  sort_type?: string;
  cat_id?: string;
}) => {
  const params: any = { page, limit };

  if (keyword) params.keyword = keyword;
  if (sort_by) params.sort_by = sort_by;
  if (sort_type) params.sort_type = sort_type;
  if (cat_id) params.cat_id = cat_id;

  const res = await axios.get(API_URL, { params });
  if (res.data?.data?.products) return res.data.data;
  return res.data.products ? res.data : res.data.data;
};

// ========================================
// üîπ Component ch√≠nh
// ========================================
const Products = () => {
  const [searchParams, setSearchParams] = useSearchParams();
  const queryClient = useQueryClient();
  const [form] = Form.useForm();

  // L·∫•y params t·ª´ URL
  const page = parseInt(searchParams.get("page") || "1");
  const limit = parseInt(searchParams.get("limit") || "5");
  const keyword = searchParams.get("keyword") || "";
  const sort_by = searchParams.get("sort_by") || "";
  const sort_type = searchParams.get("sort_type") || "";
  const cat_id = searchParams.get("cat_id") || "";

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingProduct, setEditingProduct] = useState<Product | null>(null);

  // ========================================
  // üîπ G·ªçi API qua React Query
  // ========================================
  const { data, isError, error, isFetching } = useQuery({
    queryKey: ["products", page, limit, keyword, sort_by, sort_type, cat_id],
    queryFn: () =>
      fetchProducts({ page, limit, keyword, sort_by, sort_type, cat_id }),
  });

  console.log("res.data", data);

  // ========================================
  // üîπ C·∫≠p nh·∫≠t query params (l·ªçc, ph√¢n trang)
  // ========================================
  const updateParams = (
    updates: Record<string, string | number | undefined>
  ) => {
    const newParams = new URLSearchParams(searchParams);
    Object.entries(updates).forEach(([key, value]) => {
      if (value === undefined || value === "") newParams.delete(key);
      else newParams.set(key, String(value));
    });
    setSearchParams(newParams);
  };

  // ========================================
  // üîπ Th√™m / S·ª≠a / X√≥a s·∫£n ph·∫©m
  // ========================================
  const handleSaveProduct = async () => {
    try {
      const values = await form.validateFields();

      // Chu·∫©n h√≥a d·ªØ li·ªáu tr∆∞·ªõc khi g·ª≠i
      const payload = {
        ...values,
        authors: values.authors
          ? values.authors.split(",").map((a: string) => a.trim())
          : [],
        thumbnails: values.thumbnails
          ? values.thumbnails.split(",").map((url: string) => url.trim())
          : [],
        slug:
          values.product_name
            ?.toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/(^-|-$)+/g, "") || "",
      };

      if (editingProduct) {
        await axios.put(`${API_URL}/${editingProduct._id}`, payload);
        message.success("C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng");
      } else {
        await axios.post(API_URL, payload);
        message.success("Th√™m s·∫£n ph·∫©m th√†nh c√¥ng");
      }

      setIsModalOpen(false);
      setEditingProduct(null);
      queryClient.invalidateQueries({ queryKey: ["products"] });
    } catch (err: any) {
      console.error(err);
      message.error(
        err.response?.data?.message || "C√≥ l·ªói x·∫£y ra khi l∆∞u s·∫£n ph·∫©m"
      );
    }
  };

  const handleEdit = (record: Product) => {
    setEditingProduct(record);
    form.setFieldsValue({
      ...record,
      authors: record.authors?.join(", "),
      thumbnails: record.thumbnails?.join(", "),
    });
    setIsModalOpen(true);
  };

  const handleDelete = async (id: string) => {
    try {
      await axios.delete(`${API_URL}/${id}`);
      message.success("X√≥a s·∫£n ph·∫©m th√†nh c√¥ng");
      queryClient.invalidateQueries({ queryKey: ["products"] });
    } catch {
      message.error("X√≥a th·∫•t b·∫°i");
    }
  };

  // ========================================
  // üîπ C·∫•u h√¨nh c·ªôt b·∫£ng
  // ========================================
  const columns = [
    {
      title: "·∫¢nh",
      dataIndex: "thumbnails",
      key: "thumbnails",
      render: (thumbs: string[] | string) => {
        const thumb = Array.isArray(thumbs) ? thumbs[0] : thumbs;
        return (
          <Image
            src={
              thumb?.startsWith("http")
                ? thumb
                : `${import.meta.env.VITE_BACKEND_URL_STATIC}/${thumb}`
            }
            width={60}
            height={60}
            style={{ objectFit: "cover", borderRadius: 8 }}
          />
        );
      },
    },
    { title: "T√™n s·∫£n ph·∫©m", dataIndex: "product_name", key: "product_name" },
    {
      title: "Gi√° g·ªëc",
      dataIndex: "originalPrice",
      key: "originalPrice",
      render: (price: number) => `${price?.toLocaleString()} ƒë`,
    },
    {
      title: "Gi·∫£m gi√°",
      dataIndex: "discountPercent",
      key: "discountPercent",
      render: (percent: number) => (
        <Tag color={percent > 0 ? "green" : "red"}>{percent}%</Tag>
      ),
    },
    {
      title: "Gi√° hi·ªán t·∫°i",
      dataIndex: "price",
      key: "price",
      render: (price: number) => `${price?.toLocaleString()} ƒë`,
    },
    {
      title: "Thao t√°c",
      key: "action",
      render: (record: Product) => (
        <Space>
          <Button type="primary" onClick={() => handleEdit(record)}>
            S·ª≠a
          </Button>
          <Popconfirm
            title="B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?"
            onConfirm={() => handleDelete(record._id)}
          >
            <Button danger>X√≥a</Button>
          </Popconfirm>
        </Space>
      ),
    },
  ];

  if (isError) return <Alert type="error" message={(error as Error).message} />;

  // ========================================
  // üîπ UI
  // ========================================
  return (
    <div className="p-6">
      <div className="bg-white shadow-lg rounded-xl p-6">
        {/* B·ªô l·ªçc */}
        <div className="flex flex-wrap items-center gap-4 mb-6">
          <label className="text-lg font-semibold" htmlFor="">
            Danh s√°ch s·∫£n ph·∫©m:
          </label>
          <Search
            placeholder="T√¨m s·∫£n ph·∫©m..."
            allowClear
            enterButton
            defaultValue={keyword}
            onSearch={(value) => updateParams({ keyword: value, page: 1 })}
            className="!w-100"
          />

          <Select
            placeholder="Th·ªÉ lo·∫°i"
            className="!w-40"
            value={cat_id || undefined}
            onChange={(value) => updateParams({ cat_id: value, page: 1 })}
            options={[
              { value: "", label: "T·∫•t c·∫£" },
              { value: "history", label: "L·ªãch s·ª≠" },
              { value: "novel", label: "VƒÉn h·ªçc" },
              { value: "comic", label: "Truy·ªán tranh" },
              { value: "children", label: "Thi·∫øu nhi" },
              { value: "skills", label: "K·ªπ nƒÉng" },
              { value: "foreign", label: "Ngo·∫°i vƒÉn" },
            ]}
          />

          <Select
            placeholder="S·∫Øp x·∫øp theo gi√°"
            className="!w-48"
            value={sort_type || undefined}
            onChange={(value) =>
              updateParams({ sort_type: value, sort_by: "price" })
            }
            options={[
              { value: "asc", label: "Gi√° th·∫•p ‚Üí cao" },
              { value: "desc", label: "Gi√° cao ‚Üí th·∫•p" },
            ]}
          />

          <Button
            type="primary"
            className="ml-auto"
            onClick={() => {
              setIsModalOpen(true);
              setEditingProduct(null);
              form.resetFields();
            }}
          >
            Th√™m s·∫£n ph·∫©m
          </Button>
        </div>

        {/* B·∫£ng */}
        <Table
          rowKey="_id"
          columns={columns}
          dataSource={data?.products}
          loading={isFetching}
          pagination={false}
        />

        {/* Ph√¢n trang */}
        <div className="mt-4 text-right">
          <Pagination
            current={page}
            total={20}
            pageSize={limit}
            onChange={(p) => updateParams({ page: p })}
            showTotal={(t) => `T·ªïng ${t} s·∫£n ph·∫©m`}
          />
        </div>
      </div>

      <Modal
        title={editingProduct ? "Ch·ªânh s·ª≠a s·∫£n ph·∫©m" : "Th√™m s·∫£n ph·∫©m m·ªõi"}
        open={isModalOpen}
        onCancel={() => setIsModalOpen(false)}
        onOk={handleSaveProduct}
        okText="L∆∞u"
        cancelText="H·ªßy"
        width={800}
      >
        <Form form={form} layout="vertical">
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="product_name"
                label="T√™n s·∫£n ph·∫©m"
                rules={[
                  { required: true, message: "Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m" },
                ]}
              >
                <Input />
              </Form.Item>

              <Form.Item
                name="supplier"
                label="Nh√† cung c·∫•p"
                rules={[
                  { required: true, message: "Vui l√≤ng nh·∫≠p nh√† cung c·∫•p" },
                ]}
              >
                <Input />
              </Form.Item>

              <Form.Item
                name="publisher"
                label="Nh√† xu·∫•t b·∫£n"
                rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p NXB" }]}
              >
                <Input />
              </Form.Item>

              <Form.Item
                name="authors"
                label="T√°c gi·∫£ (ph√¢n c√°ch b·∫±ng d·∫•u ph·∫©y)"
                rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p t√°c gi·∫£" }]}
              >
                <Input />
              </Form.Item>

              <Form.Item
                name="originalPrice"
                label="Gi√° g·ªëc"
                rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p gi√° g·ªëc" }]}
              >
                <Input type="number" />
              </Form.Item>

              <Form.Item name="discountPercent" label="Gi·∫£m gi√° (%)">
                <Input type="number" />
              </Form.Item>

              <Form.Item
                name="stock"
                label="S·ªë l∆∞·ª£ng t·ªìn kho"
                rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng" }]}
              >
                <Input type="number" />
              </Form.Item>
            </Col>

            <Col span={12}>
              <Form.Item
                name="thumbnails"
                label="·∫¢nh (URL, ph√¢n c√°ch b·∫±ng d·∫•u ph·∫©y)"
                rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p ·∫£nh" }]}
              >
                <Input.TextArea placeholder="https://..." rows={3} />
              </Form.Item>

              <Form.Item name="description" label="M√¥ t·∫£">
                <Input.TextArea rows={3} />
              </Form.Item>

              <Form.Item name="isNew" valuePropName="checked">
                <Checkbox>M·ªõi</Checkbox>
              </Form.Item>
              <Form.Item name="isPopular" valuePropName="checked">
                <Checkbox>Ph·ªï bi·∫øn</Checkbox>
              </Form.Item>
            </Col>
          </Row>
        </Form>
      </Modal>
    </div>
  );
};

export default Products;
